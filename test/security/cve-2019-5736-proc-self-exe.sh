#!/bin/bash
# CVE-2019-5736: /proc/self/exe Overwrite (CVSS 8.6)
# Container can overwrite host's runc binary via /proc/self/exe
# Attack: Open /proc/self/exe for writing, replace runtime binary

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$(dirname "$SCRIPT_DIR")")"

docker run --rm --security-opt seccomp=unconfined -v "$PROJECT_DIR/zig-out:/zig-out:ro" alpine /bin/sh -c '
  BEFORE=$(md5sum /zig-out/bin/bVisor | cut -d" " -f1)

  # Attempt to overwrite via /proc/self/exe
  /zig-out/bin/bVisor /bin/sh -c "echo PWNED > /proc/self/exe" 2>/dev/null || true

  AFTER=$(md5sum /zig-out/bin/bVisor | cut -d" " -f1)

  if [ "$BEFORE" = "$AFTER" ]; then
    echo "PASS: /proc/self/exe protected"
    exit 0
  else
    echo "FAIL: Binary was modified!"
    exit 1
  fi
'
