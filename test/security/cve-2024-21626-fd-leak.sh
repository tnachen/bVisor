#!/bin/bash
# CVE-2024-21626: runc FD Leak (CVSS 8.6)
# File descriptors leaked into container, including handle to host's /sys/fs/cgroup
# Attack: Set process.cwd to /proc/self/fd/7/ to access host filesystem

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$(dirname "$SCRIPT_DIR")")"

docker run --rm --security-opt seccomp=unconfined -v "$PROJECT_DIR/zig-out:/zig-out:ro" alpine /bin/sh -c '
  # Attempt to access high-numbered FDs that might leak to host
  LEAKED=0
  for fd in 3 4 5 6 7 8 9 10; do
    if /zig-out/bin/bVisor /bin/sh -c "cat /proc/self/fd/$fd 2>/dev/null" 2>/dev/null | grep -q "cgroup\|host\|docker"; then
      echo "FAIL: FD $fd leaks host access"
      LEAKED=1
    fi
  done
  [ $LEAKED -eq 0 ] && echo "PASS: No FD leaks detected"
  exit $LEAKED
'
