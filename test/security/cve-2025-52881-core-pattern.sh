#!/bin/bash
# CVE-2025-52881: /proc/sys/kernel/core_pattern (CVSS 7.3)
# Write to core_pattern executes arbitrary command on host when process crashes
# Attack: echo "|/malicious" > /proc/sys/kernel/core_pattern

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$(dirname "$SCRIPT_DIR")")"

docker run --rm --security-opt seccomp=unconfined -v "$PROJECT_DIR/zig-out:/zig-out:ro" alpine /bin/sh -c '
  BEFORE=$(cat /proc/sys/kernel/core_pattern 2>/dev/null || echo "UNREADABLE")

  /zig-out/bin/bVisor /bin/sh -c "echo \"|/malicious\" > /proc/sys/kernel/core_pattern" 2>/dev/null || true

  AFTER=$(cat /proc/sys/kernel/core_pattern 2>/dev/null || echo "UNREADABLE")

  if [ "$BEFORE" = "$AFTER" ]; then
    echo "PASS: core_pattern unchanged"
    exit 0
  else
    echo "FAIL: core_pattern was modified!"
    exit 1
  fi
'
